<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Sunburst Chart with Filtering</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow-y: auto;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        svg {
            font-size: 8px;
            margin-bottom: 20px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            font-size: 10px;
            background: lightgray;
            border: 1px solid gray;
            border-radius: 3px;
            pointer-events: none;
            opacity: 0;
        }
        .legend {
            font-size: 10px;
            margin: 10px;
            display: flex;
            flex-direction: column;
            max-height: 300px;
            overflow-y: auto;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border: 1px solid #ccc;
        }
        .controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        button, select {
            padding: 5px 10px;
            background-color: #555;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover, select:hover {
            background-color: #777;
        }
        select {
            color: black;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="reset-btn">Reset Zoom</button>
        <button id="export-btn">Export as SVG</button>
        <label for="filter-select">Filter by Province:</label>
        <select id="filter-select">
            <option value="all">All</option>
        </select>
    </div>
    <div class="container">
        <div class="tooltip" id="tooltip"></div>
        <svg width="900" height="900"></svg>
        <div class="legend" id="legend"></div>
    </div>
    <script>
        const width = 900;
        const radius = width / 2;
        const colorScheme = [
            "#9b59b6", "#8e44ad", "#d980fa", "#6c5ce7", "#74b9ff",
            "#00cec9", "#fab1a0", "#fdcb6e", "#e17055", "#00b894"
        ];
        const color = d3.scaleOrdinal(colorScheme);

        const svg = d3.select("svg")
            .attr("viewBox", [-radius, -radius, width, width])
            .append("g");

        const tooltip = d3.select("#tooltip");
        const filterSelect = d3.select("#filter-select");
        let rootData;

        function buildHierarchy(data) {
            const root = { name: "Root", children: [] };

            data.forEach(d => {
                if (d.infection_case && d.infection_case !== "Unknown") {
                    let province = root.children.find(p => p.name === d.province);
                    if (!province) {
                        province = { name: d.province, children: [] };
                        root.children.push(province);
                    }

                    let city = province.children.find(c => c.name === d.city);
                    if (!city) {
                        city = { name: d.city, children: [] };
                        province.children.push(city);
                    }

                    let caseType = city.children.find(i => i.name === d.infection_case);
                    if (!caseType) {
                        caseType = { name: d.infection_case, value: 1 };
                        city.children.push(caseType);
                    }
                }
            });

            return root;
        }

        d3.csv("PatientInfo.csv").then(data => {
            rootData = d3.hierarchy(buildHierarchy(data))
                .sum(d => d.value);

            const uniqueProvinces = Array.from(new Set(data.map(d => d.province))).filter(Boolean);
            uniqueProvinces.forEach(province => {
                filterSelect.append("option").text(province).attr("value", province);
            });

            drawSunburst(rootData);

            filterSelect.on("change", () => {
                const selectedProvince = filterSelect.node().value;
                if (selectedProvince === "all") {
                    drawSunburst(rootData);
                } else {
                    const filteredRoot = rootData.copy();
                    filteredRoot.children = filteredRoot.children.filter(d => d.data.name === selectedProvince);
                    drawSunburst(filteredRoot);
                }
            });
        });

        function drawSunburst(hierarchy) {
            svg.selectAll("*").remove();

            const partition = d3.partition().size([2 * Math.PI, radius]);

            const root = partition(hierarchy);

            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .innerRadius(d => d.y0)
                .outerRadius(d => d.y1);

            const path = svg.selectAll("path")
                .data(root.descendants())
                .enter().append("path")
                .attr("fill", d => color((d.children ? d : d.parent).data.name))
                .attr("d", arc)
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 0.9)
                        .html(`<strong>${d.data.name}</strong><br>Value: ${d.value || 0}`)
                        .style("left", `${event.pageX + 10}px`)
                        .style("top", `${event.pageY + 10}px`);
                })
                .on("mouseout", () => tooltip.style("opacity", 0))
                .on("click", (event, d) => zoomToNode(d));

            svg.selectAll("text")
                .data(root.descendants().filter(d => d.x1 - d.x0 > 0.03))
                .enter().append("text")
                .attr("transform", d => `
                    rotate(${(d.x0 + d.x1) / 2 * 180 / Math.PI - 90})
                    translate(${(d.y0 + d.y1) / 2},0)
                    rotate(${d.x1 - d.x0 > Math.PI ? 180 : 0})
                `)
                .attr("text-anchor", "middle")
                .text(d => d.data.name)
                .attr("font-size", "8px")
                .attr("fill", "white");

            d3.select("#reset-btn").on("click", () => {
                svg.transition().duration(750).attr("transform", "translate(0,0) scale(1)");
            });

            d3.select("#export-btn").on("click", () => {
                const svgData = new XMLSerializer().serializeToString(document.querySelector("svg"));
                const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "sunburst_chart.svg";
                link.click();
            });
        }

        function zoomToNode(node) {
            const scale = radius / (node.y1 - node.y0);
            const translateX = -(node.x0 + (node.x1 - node.x0) / 2) * scale;
            const translateY = -node.y0 * scale;

            svg.transition().duration(750).attr("transform", `translate(${translateX}, ${translateY}) scale(${scale})`);
        }
    </script>
</body>
</html>
