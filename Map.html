<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geographic Map Chart with Enhanced Filters</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body {
            background: linear-gradient(135deg, #e0c3fc, #8ec5fc);
            color: #333;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .controls {
            background-color: #4f4b8c;
            padding: 10px 20px;
            border-radius: 30px;
            margin: 10px 0;
            display: flex;
            gap: 15px;
            color: white;
        }

        button,
        select {
            background-color: #6c63ff;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 10px 15px;
            font-size: 14px;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        button:hover,
        select:hover {
            background-color: #4e4dc8;
            transform: scale(1.05);
        }

        .chart-container {
            flex-grow: 1;
            height: 100%;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            background-color: #f9f9f9;
            border-radius: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        svg {
            border-radius: 30px;
            width: 100%;
            height: 100%;
        }

        .tooltip {
            font-family: 'Roboto', sans-serif;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            color: #333;
            font-size: 12px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            position: absolute;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="sex-filter">Filter by Sex:</label>
        <select id="sex-filter">
            <option value="all">All</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
        </select>
        <label for="age-filter">Filter by Age Group:</label>
        <select id="age-filter">
            <option value="all">All</option>
            <option value="20s">20s</option>
            <option value="30s">30s</option>
            <option value="50s">50s</option>
        </select>
        <label for="infection-filter">Filter by Infection Case:</label>
        <select id="infection-filter">
            <option value="all">All</option>
        </select>
    </div>
    <div id="tooltip" class="tooltip"></div>
    <svg class="map" width="960" height="500"></svg>

    <script>
        const width = 960;
        const height = 500;

        const svg = d3.select(".map");

        const projection = d3.geoMercator()
            .scale(150)
            .translate([width / 2, height / 1.5]);

        const path = d3.geoPath().projection(projection);

        const tooltip = d3.select("#tooltip");

        const sexDropdown = d3.select("#sex-filter");
        const ageDropdown = d3.select("#age-filter");
        const infectionDropdown = d3.select("#infection-filter");

        let patients = [];

        Promise.all([
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
            d3.csv("PatientInfo.csv") // Replace with your CSV path
        ]).then(([world, csvData]) => {
            const countries = topojson.feature(world, world.objects.countries);

            svg.append("g")
                .selectAll("path")
                .data(countries.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", "#e0e0e0")
                .attr("stroke", "#999");

            csvData.forEach(d => {
                d.ageGroup = d.age || "unknown";
            });

            const infectionCases = Array.from(new Set(csvData.map(d => d.infection_case))).filter(Boolean);
            infectionCases.forEach(caseType => {
                infectionDropdown.append("option").attr("value", caseType).text(caseType);
            });

            const cityCoordinates = {
                "Gangseo-gu": [126.849, 37.551],
                "Jungnang-gu": [127.093, 37.595],
                "Jongno-gu": [126.979, 37.572],
                "Mapo-gu": [126.901, 37.565],
                "Seongbuk-gu": [127.020, 37.609]
            };

            csvData.forEach(d => {
                const coords = cityCoordinates[d.city];
                if (coords) {
                    d.latitude = coords[1];
                    d.longitude = coords[0];
                } else {
                    d.latitude = null;
                    d.longitude = null;
                }
            });

            patients = csvData.filter(d => d.latitude && d.longitude);

            drawNodes(patients);

            const filterData = () => {
                const selectedSex = sexDropdown.node().value;
                const selectedAge = ageDropdown.node().value;
                const selectedCase = infectionDropdown.node().value;

                let filteredPatients = patients;

                if (selectedSex !== "all") {
                    filteredPatients = filteredPatients.filter(d => d.sex.toLowerCase() === selectedSex);
                }

                if (selectedAge !== "all") {
                    filteredPatients = filteredPatients.filter(d => d.ageGroup === selectedAge);
                }

                if (selectedCase !== "all") {
                    filteredPatients = filteredPatients.filter(d => d.infection_case === selectedCase);
                }

                drawNodes(filteredPatients);
            };

            sexDropdown.on("change", filterData);
            ageDropdown.on("change", filterData);
            infectionDropdown.on("change", filterData);

            svg.call(
                d3.zoom()
                    .scaleExtent([1, 8])
                    .on("zoom", (event) => {
                        svg.selectAll("g").attr("transform", event.transform);
                    })
            );
        }).catch(err => {
            console.error("Error loading data:", err);
        });

        const drawNodes = (data) => {
            const pins = svg.selectAll(".pin")
                .data(data, d => d.patient_id);

            pins.enter()
                .append("circle")
                .attr("class", "pin")
                .attr("cx", d => projection([d.longitude, d.latitude])[0])
                .attr("cy", d => projection([d.longitude, d.latitude])[1])
                .attr("r", 5)
                .attr("fill", "steelblue")
                .attr("stroke", "#333")
                .attr("stroke-width", 0.5)
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(`
                        <strong>City:</strong> ${d.city}<br>
                        <strong>Province:</strong> ${d.province}<br>
                        <strong>Infection Case:</strong> ${d.infection_case}<br>
                        <strong>Age Group:</strong> ${d.ageGroup}<br>
                        <strong>Sex:</strong> ${d.sex}
                    `)
                        .style("left", `${event.pageX + 10}px`)
                        .style("top", `${event.pageY + 10}px`);
                })
                .on("mouseout", () => {
                    tooltip.transition().duration(200).style("opacity", 0);
                })
                .on("click", (event, d) => {
                    alert(`Details for Patient ID: ${d.patient_id}\nCity: ${d.city}\nAge Group: ${d.ageGroup}`);
                });

            pins.exit().remove();
        };
    </script>
</body>
</html>
