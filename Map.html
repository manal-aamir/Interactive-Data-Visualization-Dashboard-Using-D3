<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geographic Map Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        .map {
            border: 1px solid #ccc;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            background: lightgray;
            border: 1px solid gray;
            border-radius: 3px;
            pointer-events: none;
            opacity: 0;
        }
        .controls {
            margin: 20px;
        }
        .dropdown {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="province-filter" class="dropdown">Filter by Province:</label>
        <select id="province-filter">
            <option value="all">All</option>
        </select>
        <label for="relationship-filter" class="dropdown">Filter by Infection Case:</label>
        <select id="relationship-filter">
            <option value="all">All</option>
        </select>
    </div>
    <div id="tooltip" class="tooltip"></div>
    <svg class="map" width="960" height="500"></svg>

    <script>
        const width = 960;
        const height = 500;

        const svg = d3.select(".map");

        const projection = d3.geoMercator()
            .scale(150) // Adjust scale for zoom level
            .translate([width / 2, height / 1.5]); // Center the map

        const path = d3.geoPath().projection(projection);

        const tooltip = d3.select("#tooltip");

        // Load GeoJSON and CSV
        Promise.all([
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"), // World map
            d3.csv("PatientInfo.csv") // Your provided CSV file
        ]).then(([world, csvData]) => {
            const countries = topojson.feature(world, world.objects.countries);

            // Draw the map
            svg.append("g")
                .selectAll("path")
                .data(countries.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", "#e0e0e0")
                .attr("stroke", "#999");

            // Map city, province, and country to coordinates
            const cityCoordinates = {
                "Gangseo-gu": { latitude: 37.551, longitude: 126.849 },
                "Jungnang-gu": { latitude: 37.595, longitude: 127.093 },
                "Jongno-gu": { latitude: 37.572, longitude: 126.979 },
                "Mapo-gu": { latitude: 37.565, longitude: 126.901 }
            };

            // Add latitude and longitude to the CSV data
            csvData.forEach(d => {
                const coordinates = cityCoordinates[d.city];
                if (coordinates) {
                    d.latitude = coordinates.latitude;
                    d.longitude = coordinates.longitude;
                }
            });

            // Filter out rows without coordinates
            const filteredData = csvData.filter(d => d.latitude && d.longitude);

            // Extract unique values for filters
            const provinces = Array.from(new Set(filteredData.map(d => d.province)));
            const relationshipTypes = Array.from(new Set(filteredData.map(d => d.infection_case)));

            // Populate dropdowns
            const provinceDropdown = d3.select("#province-filter");
            const relationshipDropdown = d3.select("#relationship-filter");

            provinces.forEach(province => {
                provinceDropdown.append("option").attr("value", province).text(province);
            });

            relationshipTypes.forEach(type => {
                relationshipDropdown.append("option").attr("value", type).text(type);
            });

            // Create a color scale for infection cases
            const colorScale = d3.scaleOrdinal()
                .domain(relationshipTypes)
                .range(d3.schemeCategory10);

            // Draw pins
            const drawPins = (data) => {
                const pins = svg.selectAll(".pin")
                    .data(data, d => d.patient_id);

                // Enter new pins
                pins.enter()
                    .append("circle")
                    .attr("class", "pin")
                    .attr("cx", d => projection([d.longitude, d.latitude])[0])
                    .attr("cy", d => projection([d.longitude, d.latitude])[1])
                    .attr("r", 5)
                    .attr("fill", d => colorScale(d.infection_case))
                    .attr("stroke", "#333")
                    .attr("stroke-width", 0.5)
                    .on("mouseover", (event, d) => {
                        tooltip.transition().duration(200).style("opacity", 0.9);
                        tooltip.html(`
                            <strong>City:</strong> ${d.city}<br>
                            <strong>Province:</strong> ${d.province}<br>
                            <strong>Infection Case:</strong> ${d.infection_case}
                        `)
                        .style("left", `${event.pageX + 10}px`)
                        .style("top", `${event.pageY + 10}px`);
                    })
                    .on("mouseout", () => {
                        tooltip.transition().duration(200).style("opacity", 0);
                    });

                // Remove old pins
                pins.exit().remove();
            };

            // Initial render
            drawPins(filteredData);

            // Filter functionality
            const filterData = () => {
                const selectedProvince = provinceDropdown.node().value;
                const selectedType = relationshipDropdown.node().value;

                let filtered = filteredData;

                if (selectedProvince !== "all") {
                    filtered = filtered.filter(d => d.province === selectedProvince);
                }
                if (selectedType !== "all") {
                    filtered = filtered.filter(d => d.infection_case === selectedType);
                }

                drawPins(filtered);
            };

            provinceDropdown.on("change", filterData);
            relationshipDropdown.on("change", filterData);

            // Add zoom and pan functionality
            svg.call(
                d3.zoom()
                    .scaleExtent([1, 8]) // Zoom levels
                    .on("zoom", (event) => {
                        svg.selectAll("g").attr("transform", event.transform);
                    })
            );
        }).catch(err => {
            console.error("Error loading data:", err);
        });
    </script>
</body>
</html>
